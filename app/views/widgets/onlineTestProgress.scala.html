@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import models.page.Phase1TestsPage2
@import models.page.Phase2TestsPage2
@import models.page.PsiTestPage

@(cachedUserData: CachedData,
        dashboardPage: models.page.DashboardPage,
        assistanceDetails: Option[_root_.connectors.exchange.AssistanceDetails] = None,
        adjustments: Option[Adjustments] = None)(
        implicit request: Request[_], messages: Messages)

@import security.RoleUtils._
@import models.page.Phase2TestsPage

@requiresInvigilatedETray = @{
    adjustments.flatMap(_.adjustments).exists(_.contains("etrayInvigilated"))
}

@hasUnconfirmedAdjustments = @{
    val requiresAdjustments = assistanceDetails.exists(a => a.requiresAdjustments)
    // Some(adjustments) is returned when adjustments are confirmed,
    // otherwise None is returned. None means two cases:
    // - no adjustments have been requested
    // - adjustments have been requested, but they are awaiting confirmation
    val adjustmentsConfirmed = adjustments.flatMap(_.adjustmentsConfirmed).getOrElse(false)
    requiresAdjustments && !adjustmentsConfirmed
}

@invigilatedETraySection() = {
    <p>We're arranging for you to come in and take an invigilated e-tray.</p>
    <p>You'll be contacted by a member of our team with further details.</p>
}

@isInvigilatedVideoApproved = @{
    dashboardPage.phase3TestsPage.exists(_.isInvigilatedVideoApproved)
}

@phase2Section(phase2Test: Phase2TestsPage2) = {
    <div id="etrayBlurb">
        @if(requiresInvigilatedETray) {
            @invigilatedETraySection()
        } else {
            <p id="etrayDescription" class="">This section is timed, after starting the section you'll have 80 minutes to complete it. If we've agreed you require extra time, this will be added to the 80 minutes.</p>
            <p id="etrayTime" class="no-btm-margin">
                You have <strong>@{ phase2Test.getDuration }</strong> to finish the e-tray.
            </p>
            <p id="etrayExpires">
                It expires at <strong id="etrayExpiryTime">@{ phase2Test.getExpireTimeLondon }</strong> (London) on <strong id="etrayExpiryDate">@{ phase2Test.getExpireDateLondon }</strong>.
            </p>
            <div id="etrayTestButton">
                @helper.form(action = routes.PsiTestController.startPhase2Tests(), 'novalidate -> "novalidate") {
                    @helper.CSRF.formField
                    @{
                        if(!phase2Test.areStarted) {
                            <button id="etrayButton" type="submit" value="submit" class="button">
                                Start section
                            </button>
                        } else {
                            <button id="etrayButton" type="submit" value="submit" class="button">
                                Continue section
                            </button>
                        }
                    }
                }
                <p>(You'll have 80 minutes to finish) <br> If we've agreed you require extra time, this will be added to the 80 minutes.</p>
            </div>
        }
    </div>
}

@phase2SectionBeforeOnlineExercisesFinishes() = {
    <p class="med-btm-margin" id="etrayHeading"><i class="fa fa-lock the-icon"></i>E-tray
        <span class="font-xsmall">- locked</span>
    </p>
    <p>
        Unlocked if you're successful in the online exercises
    </p>
}

@onlineExercisesForUnconfirmedAdjustments() = {
    <p class="med-btm-margin" id="etrayHeading"><i class="fa fa-minus the-icon"></i>E-tray</p>
    <p>Before you take the e-tray we need to contact you to confirm your requested extra support.</p>
}

@displayPhase1TestResultsLinks(testsPage: Phase1TestsPage2) = {
    @testsPage.tests.map { psiTestPage =>
        <div>@Messages(psiTestPage.testNameKey)</div>
        <div>@displayTestPageLink(psiTestPage)</div>
    }
}

@generatePsiTestId(psiTestPage: PsiTestPage) = {@Messages(psiTestPage.testNameKey).replace(" ", "").concat("LinkResultsReport")}

@displayTestPageLink(testPage: PsiTestPage) = {
    @testPage.testReportUrl.map { reportUrl =>
        <a href="@reportUrl" target="_blank" id="@generatePsiTestId(testPage)">Results report</a>
    }
}

@displayPhase2TestResultsLinks() = {
    @dashboardPage.phase2TestsPage.map { testsPage =>
        @testsPage.tests.map { psiTestPage =>
            <div>@Messages(psiTestPage.testNameKey)</div>
            <div>@displayTestPageLink(psiTestPage)</div>
        }
    }
}

@displayPhase3TestResultsLinks() = {
        <a href="@routes.Phase3FeedbackController.present" target="_blank" id="phase3ResultsReportLink" alt="Phase 3 results report">Results report</a>
}

@(dashboardPage.isTestGroupExpired, dashboardPage.isPhase1TestFailed, dashboardPage.phase1TestsPage) match {
    case (true, _, Some(testsPage)) => {
        <ul class="list-text list-withicons">
            <li id="phase1TestsSection">
                <p class="med-btm-margin" id="warningOnlineExercises"><i class="fa the-icon fa-exclamation-triangle"></i>
                    Online exercises</p>
                <div id="groupTestExpired">
                    <p>Unfortunately the time you had to finish the online exercises has expired.</p>
                    <p>If you believe there's been a mistake, please <a href="@routes.ApplicationController.helpdesk()">contact us</a>
                        .</p>
                    <p>Visit the <a href="https://www.civilservicejobs.service.gov.uk" target="_blank" rel="external">Civil Service jobs</a>
                        site for more opportunities with us.</p>
                    @displayPhase1TestResultsLinks(testsPage)
                </div>
            </li>
        </ul>
    }
    case (_, true, Some(testsPage)) => {
        <ul class="list-text list-withicons">
            <li id="phase1TestsSection">
                <p class="med-btm-margin" id="warningOnlineExercises"><i class="fa the-icon fa-exclamation-triangle"></i>
                    Online exercises</p>
                <div id="phase1TestFailed">
                    <p>Unfortunately we've assessed your results and you've been unsuccessful this time.</p>
                    <p>Visit the <a href="https://www.civilservicejobs.service.gov.uk" target="_blank" rel="external">Civil Service jobs</a>
                        site for more opportunities with us.</p>
                    @displayPhase1TestResultsLinks(testsPage)
                </div>
            </li>
        </ul>
    }
    case (_, _, None) => {
        @if(isFaststream(cachedUserData)) {
            <ul class="list-text list-withicons" id="testsIndividual">
                <li id="phase1TestsSection">
                    <p class="med-btm-margin"><i class="fa fa-lock the-icon"></i>Online exercises
                        <span class="font-xsmall">- locked</span>
                    </p>
                </li>
                <li id="phase2TestsSection">
                    <p class="med-btm-margin"><i class="fa fa-lock the-icon"></i>E-tray
                        <span class="font-xsmall">- locked</span>
                    </p>
                </li>
                <li id="phase3TestsSection">
                    <p class="med-btm-margin"><i class="fa fa-lock the-icon"></i>Video interview
                        <span class="font-xsmall">- locked</span>
                    </p>
                </li>
            </ul>
        } else { @if(isEdip(cachedUserData) || isSdip(cachedUserData)) {
                <ul class="list-text list-withicons" id="testsIndividual">
                    <li id="phase1TestsSection">
                        <p class="med-btm-margin"><i class="fa fa-lock the-icon"></i>Online exercises
                            <span class="font-xsmall">- locked</span>
                        </p>
                    </li>
                    <p>We'll let you know when the online tests are ready for you to complete.</p>
                </ul>
            }
        }
    }
    case (_, _, Some(phase1TestsPage)) if cachedUserData.application.isDefined => {
        <ul class="list-text list-withicons">
            @if(phase1TestsPage.allCompleted) {
                <li id="phase1TestsSection">
                    <p class="med-btm-margin" id="testsHeading"><i class="fa fa-check the-icon"></i>
                        Online exercises</p>
                    <div>
                    @if(dashboardPage.isPhase1TestsPassed) {
                        <p>Congratulations, you've passed this section and can now continue to the next section.</p>
                        @displayPhase1TestResultsLinks(phase1TestsPage)
                    } else {
                        <p>You've completed this section, we'll send you an email when we have your results.
                            Make sure you check your junk inbox.</p>
                        @displayPhase1TestResultsLinks(phase1TestsPage)
                    }
                    </div>
                </li>

            } else {
                <li id="phase1TestsSection">
                    <p class="med-btm-margin" id="testsHeading"><i class="fa fa-minus the-icon"></i>
                        Online exercises</p>
                    <ul class="list-text list-withicons" id="testsIndividual">
                        @phase1TestsPage.tests.map { phase1Test =>
                            @if(phase1Test.completed) {
                                <li>
                                    <i class="fa fa-check the-icon"></i>
                                    <div>@Messages(phase1Test.testNameKey) (untimed)</div>
                                    <div>@displayTestPageLink(phase1Test)</div>
                                </li>
                            } else {
                                <li>
                                    <i class="fa fa-minus the-icon"></i>
                                    @Messages(phase1Test.testNameKey) (untimed)
                                </li>
                            }
                        }
                    </ul>
                    <p id="testsTime">You have <strong>@{
                        phase1TestsPage.getDuration
                    }</strong> to finish the online exercises</p>
                    <div id="testsButtonContainer">
                        @helper.form(action = routes.PsiTestController.startPhase1Tests(), 'novalidate -> "novalidate") {
                            @helper.CSRF.formField
                            @{
                                if(!phase1TestsPage.areStarted) {
                                    <button id="submit_online_tests" type="submit" value="submit" class="button">Start section</button>
                                } else {
                                    <button id="submit_online_tests" type="submit" value="submit" class="button">Continue section</button>
                                }
                            }
                        }
                        <p>(Should take about an hour to finish both exercises)</p>
                    </div>
                </li>
            }
            @if(isFaststream(cachedUserData)) {
                @(dashboardPage.isPhase2TestGroupExpired, dashboardPage.isPhase2TestsPassed, dashboardPage.isPhase2TestFailed, dashboardPage.phase2TestsPage, dashboardPage.phase1TestsPage) match {
                    case (_, true, _, _, _) => {
                        <li id="phase2TestsSection">
                            <p class="med-btm-margin" id="etrayHeading"><i class="fa the-icon fa-check"></i>E-tray</p>
                            <div id="etrayBlurb">
                                <p>Congratulations, you've passed this section and can now
                                    continue to the next section.</p>
                                @displayPhase2TestResultsLinks()
                            </div>
                        </li>
                    }
                    case (true, false, _, Some(phase2TestsPage), _) => {
                        <li id="phase2TestsSection">
                            <p class="med-btm-margin" id="warningOnlineExercises"><i class="fa the-icon fa-exclamation-triangle"></i>
                                E-tray</p>
                            <div id="groupTestExpired">
                                <p>Unfortunately the time you had to finish the e-tray has expired.</p>
                                <p>If you believe there's been a mistake, please <a href="@routes.ApplicationController.helpdesk()">contact us</a>
                                    .</p>
                                <p>Visit the <a href="https://www.civilservicejobs.service.gov.uk" target="_blank" rel="external">Civil Service jobs</a>
                                    site for more opportunities with us.</p>
                                @displayPhase2TestResultsLinks()
                            </div>
                        </li>
                    }
                     case (_, false, true, _, Some(phase1TestsPage)) => {
                        <li id="phase2TestsSection">
                            <p class="med-btm-margin" id="warningOnlineExercises"><i class="fa the-icon fa-exclamation-triangle"></i>
                                E-tray</p>
                            <div id="phase2TestFailed">
                                <p>Unfortunately we've assessed your results and you've been unsuccessful this time.</p>
                                <p>Visit the <a href="https://www.civilservicejobs.service.gov.uk" target="_blank" rel="external">Civil Service jobs</a>
                                    site for more opportunities with us.</p>
                                @phase1TestsPage.tests.map { test =>
                                    <div>@Messages(test.testNameKey)</div>
                                    <div>@displayTestPageLink(test)</div>
                                }
                            </div>
                        </li>
                    }
                    case (_, false, _, None, Some(phase1TestsPage)) => {
                        <li id="phase2TestsSection">
                            @if(dashboardPage.isPhase1TestsPassed && hasUnconfirmedAdjustments) {
                                @onlineExercisesForUnconfirmedAdjustments()
                            } else { @if(dashboardPage.isPhase1TestsPassed && requiresInvigilatedETray) {
                                <p class="med-btm-margin" id="etrayHeading"><i class="fa fa-minus the-icon"></i>E-tray</p>
                                @invigilatedETraySection
                            } else {
                                @phase2SectionBeforeOnlineExercisesFinishes()
                            }}
                        </li>
                    }
                    case (false, false, false, Some(phase2TestsPage), _) => {
                        <ul class="list-text list-withicons">
                            @if(phase2TestsPage.allCompleted) {
                                <li id="phase2TestsSection">
                                    <p class="med-btm-margin" id="etrayHeading">
                                        <i class="fa the-icon fa-check"></i>E-tray
                                    </p>
                                    <div id="etrayBlurb">
                                        <p>
                                            You've completed this section, we'll send you an email when we have your results.
                                            Make sure you check your junk inbox.
                                        </p>
                                        @phase2TestsPage.tests.map { test =>
                                            <div>@Messages(test.testNameKey)</div>
                                            <div>@displayTestPageLink(test)</div>
                                        }
                                    </div>
                                </li>
                            } else {
                                <li id="phase2TestsSection">
                                    <p class="med-btm-margin" id="etrayHeading"><i class="fa fa-minus the-icon"></i>E-tray
                                        Exercises
                                    </p>
                                    <ul class="list-text list-withicons" id="testsIndividual">
                                        @phase2TestsPage.tests.map { phase2Test =>
                                            @if(phase2Test.completed) {
                                                <li>
                                                    <i class="fa fa-check the-icon"></i>
                                                    <div>@Messages(phase2Test.testNameKey)</div>
                                                    <div>@displayTestPageLink(phase2Test)</div>
                                                </li>
                                            } else {
                                                <li>
                                                    <i class="fa fa-minus the-icon"></i>
                                                    @Messages(phase2Test.testNameKey)
                                                </li>
                                            }
                                        }
                                    </ul>
                                    @{phase2Section(phase2TestsPage)}
                                </li>
                            }
                        </ul>

                    }
                    case _ => {}
                }
                @(dashboardPage.isPhase3TestGroupExpired, dashboardPage.isPhase3TestFailed, dashboardPage.phase3TestsPage, dashboardPage.phase2TestsPage, dashboardPage.phase1TestsPage) match {
                    case (true, _, Some(phase3TestsPage), _, _) => {
                        <li id="phase3TestsSection">
                            <p class="med-btm-margin" id="warningOnlineExercises"><i class="fa the-icon fa-exclamation-triangle"></i>
                                Video interview</p>
                            <div id="groupTestExpired">
                                <p>Unfortunately the time you had to finish the video interview has expired.</p>
                                <p>If you believe there's been a mistake, please <a href="@routes.ApplicationController.helpdesk()">contact us</a>
                                    .</p>
                                <p>Visit the <a href="https://www.civilservicejobs.service.gov.uk" target="_blank" rel="external">Civil Service jobs</a>
                                    site for more opportunities with us.</p>
                            </div>
                        </li>
                    }

                    case (_, true, Some(phase3TestsPage), _, _) => {
                        <li id="phase3TestsSection">
                            <p class="med-btm-margin" id="warningOnlineExercises"><i class="fa the-icon fa-exclamation-triangle"></i>
                                Video interview</p>
                            @displayPhase3TestResultsLinks
                            <div id="phase3TestFailed">
                                <p>Unfortunately we've assessed your results and you've been unsuccessful this time.</p>
                                <p>Visit the <a href="https://www.civilservicejobs.service.gov.uk" target="_blank" rel="external">Civil Service jobs</a>
                                    site for more opportunities with us.</p>
                            </div>
                        </li>
                    }

                    case (_, _, None, _, Some(_)) => {
                        <li id="phase3TestsSection">
                            <p class="med-btm-margin" id="videoHeading"><i class="fa fa-lock the-icon"></i>Video interview
                                <span class="font-xsmall">- locked</span>
                            </p>
                            <p>Unlocked if you're successful in the e-tray</p>
                        </li>
                    }
                    case (false, false, Some(phase3TestsPage), _, _) => {
                        @if(phase3TestsPage.isCompleted) {
                            <li id="phase3TestsSection">
                                <p class="med-btm-margin" id="videoHeading"><i class="fa the-icon fa-check"></i>Video interview</p>
                                <div id="videoBlurb">
                                    <p>You've completed this section, we'll send you an email when we have your results.
                                        Make sure you check your junk inbox.</p>
                                </div>
                            </li>
                        } else {
                            <li id="phase3TestsSection">
                                <p class="med-btm-margin" id="videoHeading"><i class="fa the-icon fa-minus"></i>
                                    Video interview </p>
                                <div id="videoBlurb">
                                    @if(isInvigilatedVideoApproved) {
                                        <p>We're arranging for you to come in and take an invigilated video interview.<br />
                                            You'll be contacted by a member of our team with further details.</p>
                                    } else {
                                        <p id="videoDescription" class="">Each of your answers is timed, although you can take a
                                            break in-between questions if needed.</p>
                                        <p id="videoTime" class="">You have <strong>@{
                                            phase3TestsPage.getDuration
                                        }</strong> to finish
                                            the video interview</p>

                                        <div id="videoTestButton">
                                            @helper.form(action = routes.LaunchpadTestController.startPhase3Tests(), 'novalidate -> "novalidate") {
                                                @helper.CSRF.formField
                                                @if(!phase3TestsPage.isStarted) {
                                                    <button id="videoButton" type="submit" value="submit" class="button">
                                                        Start section</button>
                                                } else {
                                                    <button id="videoButton" type="submit" value="submit" class="button">
                                                        Continue section</button>
                                                }
                                            }
                                            <p>(The answers that you give are timed)</p>
                                        </div>
                                    }
                                </div>
                            </li>
                        }
                    }
                    case _ => {}
                }
            }
        </ul>
    }
}
@if(!dashboardPage.isTestGroupExpired && !dashboardPage.isPhase2TestGroupExpired && !dashboardPage.isPhase3TestGroupExpired) {
    <p id="testsFindOutMore"><a href="https://www.faststream.gov.uk/faqs/" rel="external" target="_blank">
        Find out more about the online tests</a></p>
}
